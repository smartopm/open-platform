# frozen_string_literal: true

# PaymentPlan
class PaymentPlan < ApplicationRecord
  belongs_to :user
  belongs_to :land_parcel
  has_many :invoices, dependent: :nullify

  before_create :set_plot_balance
  after_create :generate_monthly_invoices_for_the_year

  enum status: { active: 0, cancelled: 1, deleted: 2 }

  def update_plot_balance(amount, type = 'credit')
    return if amount.zero?

    balance = type.eql?('credit') ? (plot_balance + amount) : (plot_balance - amount)
    update(plot_balance: balance)
  end

  private

  def generate_monthly_invoices_for_the_year
    valuation = land_parcel.valuations&.latest
    return if valuation.nil?

    amount = ((percentage.to_i * valuation.amount) / 12)
    (0...12).each { |index| create_invoice_for_month(amount, start_date + index.month) }
  end

  def create_invoice_for_month(amount, date)
    invoices.create!({
                       land_parcel: land_parcel,
                       amount: amount,
                       community: user.community,
                       autogenerated: true,
                       status: 'in_progress',
                       due_date: date + 1.year,
                       user: user,
                     })
  end

  def set_plot_balance
    self.plot_balance = total_amount
  end
end
